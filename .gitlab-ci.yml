
image:
  name: "hashicorp/terraform:1.3.2"
  entrypoint: [""]

variables:
  TF_ROOT: ${CI_PROJECT_DIR}/terraform  # The relative path to the root directory of the Terraform project
  TF_STAGE: ${CI_COMMIT_BRANCH} 
  TF_ADDRESS: https://gitlab.orema.com.tr/api/v4/projects/${CI_PROJECT_ID}/terraform/state/${CI_COMMIT_BRANCH}
  TF_USERNAME: ${GITLAB_USER_NAME}
  TF_PASSWORD: ${CI_JOB_TOKEN}

stages:
  - validate
  - build

before_script:
  - cd $TF_ROOT

validate:
  stage: validate
  script:
    - terraform fmt -check
build:
  stage: build
  script:
    - chmod +x init-infra.sh
    - sh init-infra.sh
    - terraform validate

# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Terraform.gitlab-ci.yml

# include:
#   - template: Terraform/Base.gitlab-ci.yml  # https://gitlab.com/gitlab-org/gitlab/blob/master/lib/gitlab/ci/templates/Terraform/Base.gitlab-ci.yml
#   - template: Jobs/SAST-IaC.gitlab-ci.yml   # https://gitlab.com/gitlab-org/gitlab/blob/master/lib/gitlab/ci/templates/Jobs/SAST-IaC.gitlab-ci.yml


# variables:
#   TF_ROOT: ${CI_PROJECT_DIR}/terraform  # The relative path to the root directory of the Terraform project
#   TF_STATE_NAME: ${TF_STATE_NAME:-default}  # The name of the state file used by the GitLab Managed Terraform state backend
#   TF_ADDRESS: https://gitlab.orema.com.tr/api/v4/projects/${CI_PROJECT_ID}/terraform/state/$CI_COMMIT_BRANCH}"


# stages:
#   - validate
#   - test
#   - build
#   - deploy

# fmt:
#   extends: .terraform:fmt
#   needs: []

# validate:
#   extends: .terraform:validate
#   needs: []

# build:
#   extends: .terraform:build

# deploy:
#   extends: .terraform:deploy
#   dependencies:
#     - build
#   environment:
#     name: $TF_STATE_NAME